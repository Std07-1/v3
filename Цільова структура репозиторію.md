## 1) Цільова структура репозиторію (Annotated tree, ASCII)

```
v3/
├─ app/                              # composition root: запуск процесів, wiring, DI/registry
│  ├─ main.py                         # entrypoint (один процес або supervisor)
│  ├─ composition.py                  # збір компонентів (ingest/store/publish/ui/smc/exe)
│  └─ lifecycle.py                    # start/stop, health, graceful shutdown
│
├─ config/                            # SSOT конфіги (НЕ ENV)
│  ├─ config.py|json                   # ports, NS, tf allowlist, budgets, paths
│  ├─ calendar_overrides.json          # closed_intervals_utc, day boundary, tags
│  └─ profiles/                        # env profiles (dev/stage/prod), без секретів
│
├─ core/                               # PURE: без I/O, без Redis, без broker SDK
│  ├─ time_geom.py                     # end-incl, event_ts rules, normalize
│  ├─ buckets.py                       # tf_to_ms, anchor, bucket_start/end
│  ├─ contracts/                       # SSOT схеми/типи публічних payload’ів
│  │  ├─ public/
│  │  │  ├─ ohlcv_event_v1.json        # BarUpdateEvent
│  │  │  ├─ tick_v1.json               # Tick (якщо публікується)
│  │  │  ├─ status_v2.json             # status + snapshot
│  │  │  └─ commands_v1.json           # command bus API
│  │  └─ smc_hint_v1.json              # SmcHint (публічний контракт)
│  ├─ validation/
│  │  └─ validator.py                  # allowlist + fail-fast (contract-first)
│  ├─ model/
│  │  ├─ bars.py                       # Bar, BarKey, BarUpdateEvent (typed)
│  │  ├─ status.py                     # StatusSnapshot types
│  │  └─ smc.py                        # SMC types (zones/liquidity/structure)
│  └─ utils/
│     └─ json_codec.py                 # canonical JSON dumps/loads (детермінізм)
│
├─ runtime/                            # I/O, процеси, мережа, Redis, брокери
│  ├─ ingest/
│  │  ├─ broker/                       # адаптери до брокерів
│  │  │  ├─ fxcm/                      # ForexConnect owner-thread
│  │  │  │  ├─ stream.py               # ticks/offers stream
│  │  │  │  ├─ history.py              # history fetch (budgeted)
│  │  │  │  └─ session.py              # login/heartbeat/status
│  │  │  └─ oanda/ ...                 # future
│  │  ├─ polling/                      # close-detection, fast-path 1m
│  │  │  ├─ connector.py               # PollingConnector (thin orchestration)
│  │  │  ├─ scheduler.py               # heavy_budget_s, defer heavy
│  │  │  ├─ live_builder.py            # preview (ticks -> live bar) optional
│  │  │  └─ derived_builder.py         # HTF from 1m final (SSOT)
│  │  └─ commands/                     # command handlers
│  │     ├─ warmup.py
│  │     ├─ backfill.py
│  │     ├─ tail_guard.py
│  │     └─ republish_tail.py
│  │
│  ├─ store/
│  │  ├─ ssot_jsonl.py                 # append-only JSONL writer/reader
│  │  ├─ ssot_sqlite.py                # optional WAL SSOT (1m final truth)
│  │  └─ cache_tail.py                 # rolling window cache (rebuildable)
│  │
│  ├─ publish/
│  │  ├─ redis_surface.py              # Public Surface writer (streams+snapshots)
│  │  ├─ http_api.py                   # read-only /api/bars,/status (bootstrap)
│  │  └─ ws_sse.py                     # UI stream (WS/SSE) from Redis streams
│  │
│  ├─ status/
│  │  ├─ builder.py                    # status + status:snapshot SSOT
│  │  └─ health.py                     # liveness/readiness/watermarks/warnings
│  │
│  └─ governance/
│     ├─ rails.py                      # stop-rules, drift detection, loud errors
│     └─ metrics.py                    # minimal counters/latency (optional Prom)
│
├─ smc/                                 # (майбутнє) SMC layer
│  ├─ engine.py                        # deterministic pipeline (final-only)
│  ├─ structure/
│  ├─ liquidity/
│  ├─ zones/
│  ├─ scoring/
│  └─ publish.py                       # emit smc:hints/events + snapshots
│
├─ execution/                           # (майбутнє) trade execution + risk
│  ├─ risk/
│  │  ├─ limits.py                     # per-trader, per-symbol, per-day
│  │  └─ validator.py                  # OrderIntent -> allow/deny
│  ├─ broker_gateway/
│  │  ├─ fxcm_orders.py                # place/modify/cancel (idempotent req_id)
│  │  └─ oanda_orders.py ...
│  └─ model/
│     ├─ intent_v1.json                # OrderIntent contract
│     └─ events_v1.json                # Order events/positions snapshots
│
├─ ui/                                  # UI web client + overlays
│  ├─ server/                          # thin server (same-origin) або статика
│  └─ web/                             # static frontend
│     ├─ index.html
│     ├─ app.js                        # applyUpdates(final>preview, NoMix)
│     └─ chart_adapter.js
│
├─ tools/                               # одноразові утиліти
│  ├─ audit/
│  ├─ repair/
│  ├─ replay/
│  └─ migrate/
│
├─ deploy/                              # systemd/nginx/runbooks/docker
└─ docs/                                # SSOT docs, runbooks, ADR
```

---

## 2) “Гілки наступних шарів” (як вони стикуються)

**Connector (Ingest/Store/Publish)** — це `runtime/ingest + runtime/store + runtime/publish`.
**UI** — тільки читає snapshot + підписується на стрім.
**SMC** — (майбутнє) читає **тільки final** з Public Surface, публікує `smc:hints`.
**Execution** — (майбутнє) читає сигнали/інтенти, проходить risk, шле ордери через broker_gateway.

---

## 3) ASCII-схема конектора як системи (процеси + Redis Public Surface)

```
┌─────────────────────────────────────────────────────────────────────┐
│                           CONNECTOR (runtime)                        │
├───────────────────────────────┬─────────────────────────────────────┤
│ Broker adapters                │ Internal rails/health               │
│ (FXCM/OANDA)                   │ (allowlist, calendar=signal,        │
│                                │  watermarks)                        │
└───────────────┬───────────────┴──────────────────────┬──────────────┘
                │ ticks/offers                           │ internal calls
                ▼                                        ▼
        ┌─────────────────┐                      ┌───────────────────┐
        │ Tick Ingest      │                      │ Command Handlers  │
        │ (owner-thread)   │                      │ (internal/CLI)    │
        └───────┬─────────┘                      └─────────┬─────────┘
                │                                          │
                ▼                                          ▼
        ┌─────────────────┐                      ┌───────────────────┐
        │ Preview Builder  │                      │ Warmup/Backfill   │
        │ (live bar)       │                      │ Tail-guard/Repair │
        │ complete=false   │                      │ budgeted history  │
        └───────┬─────────┘                      └─────────┬─────────┘
                │ preview events                           │ final bars
                ├──────────────────────────────┬───────────┘
                ▼                              ▼
        ┌─────────────────────────────────────────────────────────────┐
        │ SSOT Writer (JSONL)                                          │
        │ - append-only                                                 │
        │ - 1m final truth                                              │
        └───────────────────────┬─────────────────────────────────────┘
                                │ publish fast-path (priority)
                                ▼
                     ┌────────────────────────────────┐
                     │ Redis Public Surface (SSOT API) │
                     ├────────────────────────────────┤
                     │ NS:ohlcv:events   (stream)      │  <-- upsert events
                     │ NS:ohlcv:snap:*   (snapshot)    │  <-- rolling window
                     │ NS:price_tik      (tick cache)  │  <-- optional
                     │ NS:status         (live status) │
                     │ NS:status:snapshot (last_command, errors[])     │
                     │ (без NS:commands)                               │
                     └───────────────┬────────────────┘
                                     │
                                     ▼
                      ┌────────────────────────────────┐
                      │ UI (WS/SSE subscribe + HTTP)    │
                      │ - subscribe events stream       │
                      │ - bootstrap via snapshot/HTTP    │
                      │ - final>preview, NoMix(final)    │
                      └────────────────────────────────┘
```

---

## 4) “Один контракт” у цій схемі (коротко, але жорстко)

* Бар: `open_ms`, `close_ms` **end-incl** (`close=open+tf_ms-1`)
* Подія: `BarUpdateEvent` = upsert по `(symbol, tf, open_ms)` + `(complete, source)` + `event_ts`
* `complete=true` (final) ⇒ `event_ts == close_ms` і `source ∈ FINAL_SOURCES`
* UI merge policy: **final > preview**, **NoMix(final)**

---
