# ADR 0013: D1 Chart Rendering Fix (Time Domain Mapping)

## üìå –ö–æ–Ω—Ç–µ–∫—Å—Ç
–ü—Ä–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—ñ —Ç–∞–π–º—Ñ—Ä–µ–π–º—É D1 (1 –¥–µ–Ω—å) –≤–∏—è–≤–ª–µ–Ω–æ –≤—ñ–∑—É–∞–ª—å–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É: –≤–µ–ª–∏—á–µ–∑–Ω—ñ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ñ "–¥—ñ—Ä–∫–∏" –≤ —ñ—Å—Ç–æ—Ä—ñ—ó (–ø—Ä–æ–ø—É—â–µ–Ω—ñ —Å–≤—ñ—á–∫–∏) –±–µ–∑–ø–µ—Ä–µ—Ä–≤–Ω–æ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç–∏–∂–Ω—è.
–ü—Ä–∏—á–∏–Ω–∞: —Å–≤—ñ—á–∫–∏ –ø–æ–Ω–µ–¥—ñ–ª–∫–∞ –¥–ª—è –±—ñ–ª—å—à–æ—Å—Ç—ñ –±—Ä–æ–∫–µ—Ä—ñ–≤ (–≤ —Ç.—á. FXCM) –≤—ñ–¥–∫—Ä–∏–≤–∞—é—Ç—å—Å—è —É –Ω–µ–¥—ñ–ª—é –æ 21:00 –∞–±–æ 22:00 –∑–∞ UTC. 
–†–∞–Ω—ñ—à–µ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—ñ (UI v4) –¥–ª—è D1 —Å–≤—ñ—á–æ–∫ —á–∞—Å –ø–µ—Ä–µ–¥–∞–≤–∞–≤—Å—è –¥–æ Lightweight Charts (LWC) —É –≤–∏–≥–ª—è–¥—ñ –≤—ñ–¥—Ñ–æ—Ä–º–∞—Ç–æ–≤–∞–Ω–æ–≥–æ —Ä—è–¥–∫–∞ `"YYYY-MM-DD"`. –¶–µ–π –ø—ñ–¥—Ö—ñ–¥ –±—É–≤ —É—Å–ø–∞–¥–∫–æ–≤–∞–Ω–∏–π –∑ v3 —ñ —Ä–æ–±–∏–≤ –≥—Ä–∞—Ñ—ñ–∫ —á—É—Ç–ª–∏–≤–∏–º –¥–æ "–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∏—Ö –¥—ñ—Ä–æ–∫" ‚Äî LWC –Ω–∞–º–∞–≥–∞–≤—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–¥–µ–∞–ª—å–Ω–æ —Ä—ñ–≤–Ω–æ–º—ñ—Ä–Ω—É –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É –ø–ª–æ—â–∏–Ω—É –æ—Å—ñ X —ñ –≤—ñ–¥–æ–±—Ä–∞–∂–∞–≤ —Ä–æ–∑—Ä–∏–≤–∏ —É –≤–∏—Ö—ñ–¥–Ω—ñ –¥–Ω—ñ, —è–∫—ñ –ª–∞–º–∞–ª–∏—Å—è –ø—ñ–¥ —á–∞—Å –∑—Å—É–≤—É —Å–µ—Å—ñ–π —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä—è–¥–∫—ñ–≤.

## üéØ –†—ñ—à–µ–Ω–Ω—è
–ë—É–ª–æ –ø—Ä–∏–π–Ω—è—Ç–æ —Ä—ñ—à–µ–Ω–Ω—è –≤—ñ–¥–º–æ–≤–∏—Ç–∏—Å—å –≤—ñ–¥ "–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ" —Ä—è–¥–∫–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É `YYYY-MM-DD` –Ω–∞ –∫–æ—Ä–∏—Å—Ç—å **—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —á–∏—Å–ª–æ–≤–æ–≥–æ (epoch seconds)** –¥–ª—è –≤—Å—ñ—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º—ñ–≤, –≤–∫–ª—é—á–∞—é—á–∏ `D1` —Ç–∞ —Å—Ç–∞—Ä—à–µ.

–ó–º—ñ–Ω–∏ —É `ui_v4/src/chart/engine.ts`:
1. –ó–∞–º—ñ—Å—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó –¥–∞—Ç–∏ —É —Ä—è–¥–æ–∫, –º–∏ –∑–∞–ª–∏—à–∞—î–º–æ `time` —è–∫ —á–∏—Å–ª–æ `Math.floor(tMs / 1000)`.
2. –©–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π "–Ω–æ–º—ñ–Ω–∞–ª—å–Ω–∏–π" –¥–µ–Ω—å (—â–æ–± —Å–µ—Å—ñ—è –ø–æ–Ω–µ–¥—ñ–ª–∫–∞ –Ω–µ –º–∞—Ä–∫—É–≤–∞–ª–∞—Å—è –Ω–µ–¥—ñ–ª–µ—é —á–µ—Ä–µ–∑ 22:00 UTC), –º–∏ –∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –∑—Å—É–≤ `D1_OFFSET_MS` (+3 –≥–æ–¥–∏–Ω–∏) –ø–µ—Ä–µ–¥ –¥—ñ–ª–µ–Ω–Ω—è–º –Ω–∞ —Å–µ–∫—É–Ω–¥–∏.

```typescript
// ui_v4/src/chart/engine.ts
private _mapCandle(c: Candle): {
  time: Time; open: number; high: number; low: number; close: number;
} {
  const tMs = this._tfS >= 86400 ? (c.t_ms + D1_OFFSET_MS) : c.t_ms;
  const time = Math.floor(tMs / 1000) as Time;
  return { time, open: c.o, high: c.h, low: c.l, close: c.c };
}
```

### üéØ –î–æ–ø–æ–≤–Ω–µ–Ω–Ω—è: –°–∞–Ω—ñ—Ç–∏–∑–∞—Ü—ñ—è –î–∞–Ω–∏—Ö (Data Sanitization) —Ç–∞ –ó–≤–æ—Ä–æ—Ç–Ω—ñ–π –ú–∞–ø—ñ–Ω–≥ –ß–∞—Å—É
–î–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É (–±–µ–∑ –∑–±–æ—ó–≤ LWC —á–µ—Ä–µ–∑ `Value is null` –∞–±–æ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ —á–∞—Å—É) —ñ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –¥–∞—Ç –ø—Ä–∏ –≤–∑–∞—î–º–æ–¥—ñ—ó —é–∑–µ—Ä–∞/—Ç—É–ª–±–∞—Ä—ñ–≤ –∑ –≥—Ä–∞—Ñ—ñ–∫–æ–º D1 (crosshair), –±—É–ª–∏ –¥–æ–¥–∞–Ω—ñ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫–∏:

1. **`_normalizeCandle`**: –í–∞–ª—ñ–¥—É—î –ø–æ–ª—è (`t_ms`, `o`, `h`, `l`, `c`). –í—ñ–¥–∫–∏–¥–∞—î –±–∞—Ä–∏ –∑ `NaN` –∞–±–æ –Ω–µ–≥–∞–≤–∞–ª—å–Ω–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Whitespace-–¥–∞–Ω—ñ –±–µ–∑ —Ü—ñ–Ω). –ù–æ—Ä–º–∞–ª—ñ–∑—É—î –µ–∫—Å—Ç—Ä–µ–º—É–º–∏: high –∑–∞–≤–∂–¥–∏ –º–∞–∫—Å–∏–º—É–º –∑ (o, h, l, c), low ‚Äî –º—ñ–Ω—ñ–º—É–º.
2. **`_prepareBars`**: –ó–¥—ñ–π—Å–Ω—é—î deduplication –∑–∞ `t_ms` (–∑–∞–ª–∏—à–∞—é—á–∏ **–Ω–∞–π–Ω–æ–≤—ñ—à–∏–π** –¥—É–±–ª—ñ–∫–∞—Ç) —Ç–∞ –≥–∞—Ä–∞–Ω—Ç—É—î —Å—Ç—Ä–æ–≥–µ —Ö—Ä–æ–Ω–æ–ª–æ–≥—ñ—á–Ω–µ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ—é –¥–æ –≥—Ä–∞—Ñ—ñ—á–Ω–æ–≥–æ —Ä—É—à—ñ—è. –¶–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –¥–æ —ñ—Å—Ç–æ—Ä—ñ—ó (`setData`), –¥–æ–≥—Ä—É–∑–∫–∏ (`prependData`), —ñ –¥–µ–ª—å—Ç–∏ (`update`).
3. **`_timeToMs`**: –û—Å–∫—ñ–ª—å–∫–∏ LWC —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î –∑ —á–∏—Å–ª–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º –¥–ª—è D1, –º–∏ –ø–æ–≤–∏–Ω–Ω—ñ –ø—Ä–∏ –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó (X-–≤—ñ—Å—å ‚Üí ms) **–≤—ñ–¥–Ω—ñ–º–∞—Ç–∏** `D1_OFFSET_MS`, —â–æ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ `t_ms` (–ø–æ—á–∞—Ç–∫—É —Ç–æ—Ä–≥–æ–≤–æ—ó —Å–µ—Å—ñ—ó). 

```typescript
// ui_v4/src/chart/engine.ts
private _timeToMs(time: Time): number {
  if (typeof time === 'number') {
    const ms = time * 1000;
    return this._tfS >= 86400 ? ms - D1_OFFSET_MS : ms;
  }
  // ...
}
```


### üéØ –°–µ—Ä–≤–µ—Ä–Ω–∏–π –®–∞—Ä (Backend data sanitization)
–õ—ñ–∫—É–≤–∞–Ω–Ω—è "–ø–æ–±–∏—Ç–∏—Ö —Ö–≤–æ—Å—Ç—ñ–≤" —ñ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ —Ç–∞–∫–æ–∂ –±—É–ª–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–∏–π –º–∞–ø–ø–µ—Ä `runtime/ws/candle_map.py`. –¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –Ω–µ —Ç—ñ–ª—å–∫–∏ –Ω–æ–≤—ñ –¥–µ–ª—å—Ç–∏ –∑ –≤–µ–±—Å–æ–∫–µ—Ç–∞, –∞–ª–µ –π **–ø–µ—Ä–≤–∏–Ω–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—è**, —è–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –≥—Ä–∞—Ñ—ñ–∫, —î –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ "—á–∏—Å—Ç–æ—é" —Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–æ—é:

1. **–ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è —Ö–≤–æ—Å—Ç—ñ–≤ (Tail Normalization)**: `h = max(o,h,l,c)` —Ç–∞ `l = min(o,h,l,c)`. –ó–∞—Ö–∏—â–∞—î –≤—ñ–¥ –∑–ª–∞–º–∞–Ω–∏—Ö –±–∞—Ä—ñ–≤ –≤—ñ–¥ –±—Ä–æ–∫–µ—Ä–∞.
2. **–ù—É–ª—å–æ–≤–∏–π –æ–±'—î–º**: –Ø–∫—â–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤—ñ–¥'—î–º–Ω–∏–π –æ–±'—î–º (`v < 0`), –≤—ñ–Ω –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ `0.0`.
3. **–°—Ç–∞–±—ñ–ª—å–Ω–∏–π –î–µ–¥—É–ø–ª—ñ–∫–∞—Ç–æ—Ä**: –í `map_bars_to_candles_v4` –¥—É–±–ª—ñ–∫–∞—Ç–∏ `t_ms` –≤—ñ–¥–∫–∏–¥–∞—é—Ç—å—Å—è (–æ—Å—Ç–∞–Ω–Ω—ñ–π –±–∞—Ä –ø–µ—Ä–µ–º–∞–≥–∞—î), —ñ –≤—Å—ñ –±–∞—Ä–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç—å —á–µ—Ä–µ–∑ —Å—É–≤–æ—Ä–µ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑–∞ —á–∞—Å–æ–º, —â–æ–± —ñ—Å—Ç–æ—Ä—ñ—è –≤—ñ–¥—Å–∏–ª–∞–ª–∞—Å—å –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é —ñ –±–µ–∑ –∑–∞—Ü–∏–∫–ª–µ–Ω—å LWC.


## ‚öñÔ∏è –ù–∞—Å–ª—ñ–¥–∫–∏ / –Ü–Ω–≤–∞—Ä—ñ–∞–Ω—Ç–∏ (I2, I5)
- **Positive:** LWC –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–æ–ª–∞–ø—Å—É—î –≤–∏—Ö—ñ–¥–Ω—ñ –¥–Ω—ñ (–≤–∏–¥–∞–ª—è—î –≤—ñ–∑—É–∞–ª—å–Ω—ñ —Ä–æ–∑—Ä–∏–≤–∏) –ø—Ä–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ —Ç–∏–ø—É `number` (–±–µ–∑–ø–µ—Ä–µ—Ä–≤–Ω–∏–π —Ä—è–¥ epoch seconds). –ì—Ä–∞—Ñ—ñ–∫–∏ D1 —Ç–µ–ø–µ—Ä –≤–∏–≥–ª—è–¥–∞—é—Ç—å –Ω–µ–ø–µ—Ä–µ—Ä–≤–Ω–æ —Ç–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ.
- **Positive:** –ó–∞–±–∏—Ä–∞—î—Ç—å—Å—è –∑–∞–π–≤–∞ –ª–æ–≥—ñ–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É —Ä—è–¥–∫—ñ–≤.
- **Positive:** –ü–æ–¥–≤—ñ–π–Ω–∞ —Å–∞–Ω—ñ—Ç–∏–∑–∞—Ü—ñ—è —Ç–∞ –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—è (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —ñ –±–µ–∫–µ–Ω–¥) –∑–∞–ø–æ–±—ñ–≥–∞—é—Ç—å –ø–∞–¥—ñ–Ω–Ω—è–º Lightweight Charts –Ω–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö –±—Ä–æ–∫–µ—Ä—ñ–≤ —ñ –∑–∞–ø–æ–±—ñ–≥–∞—é—Ç—å –≤—ñ–∑—É–∞–ª—å–Ω–∏–º "–∑–ª–∞–º–∞–Ω–∏–º" —Å–≤—ñ—á–∫–∞–º (–¥–µ —Ç—ñ–ª–æ –≤–∏—Ö–æ–¥–∏—Ç—å –∑–∞ —Ö–≤–æ—Å—Ç–∏).
- **Negative:** –ù–µ–º–∞—î. –¶–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏—Ä—ñ—à—É—î –±–∞–≥ –∑ —Ä–æ–∑—Ä–∏–≤–æ–º –æ—Å—ñ –Ω–∞ D1 –±–µ–∑ –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è –±–µ–∫–µ–Ω–¥—É ingest.

## üìÖ –°—Ç–∞—Ç—É—Å
**Implemented** (2026-02-25)
